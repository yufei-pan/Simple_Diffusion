<!DOCTYPE html>
<html>
<head>
    <script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../static/styles.css">
    <title>
        {% if shortuuid %}
            Viewing {{ shortuuid }}
        {% else %}
            Album View
        {% endif %}
    </title>
</head>
<body>
<header></header>
<meta name="viewport" content="width=device-width">
<h1>        
{% if shortuuid %}
    Viewing {{shortuuid}}
{% else %}
    Album View
{% endif %}
</h1>
<a href='https://zopyr.us'>By Kes</a><br>


<h2>View one of your own album:</h2>
<form id="working_album">
        <label for="album_key">Choose an album:</label>
        <select id="album_key" name="album_key">
        </select>
        <br>
        <label for="album_key_in">Or Using An Album Access Key:</label><br>
        <input type="text" id="album_key_in" name="album_key_in"><br>
        <input type="submit" value="Load!">
</form>

<h2>View other's album:</h2>
<form id="find_album">
        <label for="album_key_view">Choose an album loaded before:</label>
        <select id="album_key_view" name="album_key_view">
        </select>
        <br>
        <label for="album_key_view_in">Or Using An Album View Key:</label><br>
        <input type="text" id="album_key_view_in" name="album_key_view_in"><br>
        <input type="submit" value="Load!">
</form>

<h2 id="album_name">Gallery </h2>
Nick name:
<div id="nickname"></div><br>
By:
<div id="by"></div><br>
Album Description:<br>
<div id="album_description" ></div>
<br>
<div id="album_view">
    <!-- An album of image generated by this machine (saved locally) -->
    <!-- What is saved is only the UUID and a nickname for each image -->
    <!-- Each image will have two button - delete and rename -->
    <!-- Also a button to save album locally (just a csv)-->
    <!-- Maybe a button to get a shareable link -->
    <!-- Shareable link is done by transmit the image ids to the server -->
    <!-- And the server will store this data in a albums db, access by another uuid -->
    <!-- Image is just raw doog loaded -->
</div>


<script type = "text/javascript">
    shortuuid = "{{ shortuuid }}"
    console.log(shortuuid)
    if (shortuuid && shortuuid != 'None'){
        loadAlbum(shortuuid);
    }else{
        var localAlbum = JSON.parse(localStorage.getItem("localAlbum"));
        if (!localAlbum){localAlbum={ID:'localAlbum',images:[],description:'My Images'}};
        var workingAlbum = localAlbum
        if (workingAlbum.description){
            $('#album_description').html(workingAlbum.description)
        }

        if (workingAlbum.nickname){
            $('#nickname').html(workingAlbum.nickname)
        }
    }

    var myAlbums = JSON.parse(localStorage.getItem("myAlbums"))
    if (!myAlbums){
        myAlbums=new Map()
    }else{
        myAlbums = new Map(Object.entries(myAlbums));
    }


    
    myAlbums.forEach (function(data, ID) {
        // <option value="volvo">Volvo</option>
        if (!data.name){
            $('#album_key').append($('<option value="'+ID+'">'+ID+'</option>'))
        }else{
            $('#album_key').append($('<option value="'+ID+'">'+data.name+'</option>'))
        }
    })
    $(document).ready( function () {
        $('#working_album').on( "submit", function(e){
            if ($('#album_key_in').val()){
                $.getJSON( "../get_album_id/"+$('#album_key_in').val(), function( id ) {
                    myAlbums.set(id.ID,{'ID':id.ID,'key':$('#album_key_in').val()});
                    localStorage.setItem("myAlbums",JSON.stringify(Object.fromEntries(myAlbums)));
                    loadAlbum(id.ID);
                }).fail(function(error) {
                    console.log(error.responseJSON);
                    alert(JSON.stringify(error.responseJSON));
                });
            }else{
                loadAlbum($('#album_key').val());
            }
            e.preventDefault();
        });
    });

    function loadAlbum(id){
    $.getJSON( "../album_json/"+id, function( data ) {
        console.log('The album requested is:');
        console.log(data);
        workingAlbum = data;
        workingAlbum.key = myAlbums.get(id).key
        localStorage.setItem(workingAlbum.ID, JSON.stringify(workingAlbum));
        $('#album_name').html('Viewing Album '+id);
        if ("nickname" in data){
            $('#nickname').html(data.nickname);
        }
        if ("by" in data){
            $('#by').html(data.by);
        }
        if ("description" in data){
            $('#album_description').html(data.description);
        }
        formGallery();
    }).fail(function(error) {
        console.log(error.responseJSON);
        alert(JSON.stringify(error.responseJSON))
    });
}

function formGallery(){
    var count = 0
    var cards = $("<div class='cards'></dev>");
    for (let idx in workingAlbum.images){
        let UUID = workingAlbum.images[workingAlbum.images.length-idx-1];
        //console.log(UUID);
        var card = $("<div class='card' id='"+UUID+"'></div>");
        card.append($("<h3>"+UUID+"<h3/>"));
        card.append($("<img src='../image/"+UUID+"'/>"));
        card.append($("<br/>"));
        if (!localStorage.getItem(UUID)){
            $.getJSON( "../get_info/"+UUID, function( data ) {
                localStorage.setItem(UUID, JSON.stringify(data));
            }).fail(function(error) {
                console.log(error.responseJSON);
                alert(JSON.stringify(error.responseJSON))
            });
        }
        card.append($('<pre class="info"></pre>').html(JSON.stringify(JSON.parse(localStorage.getItem(UUID)), null, 2)));
        card.append($("<br/>"));
        cards.append(card);
        count++;
    }
    if (count == 0){
        $("#album_view").html('<div id = "no_result">No images in local storage.</div>');
    }else{
        $("#album_view").html('');
        $("#album_view").append(cards);
    }
    $('#album_view').show();
}

</script>

<footer></footer>
</body>
</html>
