<!DOCTYPE html>
<html>
<head>
    <script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../static/styles.css">
    <link rel = "icon" href = "../static/ico.png" type = "image/x-icon">
    <title>
        {% if shortuuid %}
            Viewing {{ shortuuid }}
        {% else %}
            Album View
        {% endif %}
    </title>
    
</head>
<body>
<header></header>
<meta name="viewport" content="width=device-width">
<h1>        
{% if shortuuid %}
    Viewing {{shortuuid}}
{% else %}
    Album View
{% endif %}
</h1>
<a href='https://zopyr.us'>By Kes</a><br>


<h2>View one of your own album:</h2>
<form id="working_album">
        <label for="album_key">Choose an album:</label>
        <select id="album_key" name="album_key">
        </select>
        <br>
        <label for="album_key_in">Or Using An Album Access Key:</label><br>
        <input type="text" id="album_key_in" name="album_key_in"><br>
        <input type="submit" value="Load!">
</form>

<h2>View other's album:</h2>
<form id="find_album">
        <label for="album_key_view">Choose an album loaded before:</label>
        <select id="album_key_view" name="album_key_view">
        </select>
        <br>
        <label for="album_key_view_in">Or Using An Album View Key:</label><br>
        <input type="text" id="album_key_view_in" name="album_key_view_in"><br>
        <input type="submit" value="Load!">
</form>

<h2 id="album_name">Gallery </h2>
Nick name:
<div id="nickname"></div><br>
By:
<div id="by"></div><br>
Album Description:<br>
<div id="album_description" ></div>
<button type="button" id="hide_info_button">Hide Info about Individual images</button>
<br>
<br>
<br>
<div id="album_view">
    <!-- An album of image generated by this machine (saved locally) -->
    <!-- What is saved is only the UUID and a nickname for each image -->
    <!-- Each image will have two button - delete and rename -->
    <!-- Also a button to save album locally (just a csv)-->
    <!-- Maybe a button to get a shareable link -->
    <!-- Shareable link is done by transmit the image ids to the server -->
    <!-- And the server will store this data in a albums db, access by another uuid -->
    <!-- Image is just raw doog loaded -->
</div>


<script type = "text/javascript">
    shortuuid = "{{ shortuuid }}";
    remainingCards = [];
    console.log(shortuuid)

    var workingAlbum;
    var localAlbum = JSON.parse(localStorage.getItem("localAlbum"));
    if (!localAlbum){localAlbum={ID:'localAlbum',images:[],description:'My Images'}};
    var myAlbums = JSON.parse(localStorage.getItem("myAlbums"))
    if (!myAlbums){
        myAlbums=new Map(Object.entries({localAlbum:{ID: 'localAlbum', key: 'localAlbum'}}))
    }else{
        myAlbums = new Map(Object.entries(myAlbums));
    }

    var viewAlbums = JSON.parse(localStorage.getItem("viewAlbums"))
    if (!viewAlbums){
        viewAlbums=[]
    }


    if (shortuuid && shortuuid != 'None'){
        loadAlbum(shortuuid);
    }else{
        formAlbumList();
        workingAlbum = localAlbum
    }

    $(document).ready( function () {
        $('#working_album').on( "submit", function(e){
            if ($('#album_key_in').val()){
                $.getJSON( "../album_id/"+$('#album_key_in').val(), function( id ) {
                    myAlbums.set(id.ID,{'ID':id.ID,'key':$('#album_key_in').val()});
                    localStorage.setItem("myAlbums",JSON.stringify(Object.fromEntries(myAlbums)));
                    console.log('Loading Album '+id.ID)
                    //loadAlbum(id.ID);
                    $(location).attr("href", "id.ID");
                }).fail(function(error) {
                    console.log(error.responseJSON);
                    alert(JSON.stringify(error.responseJSON));
                });
            }else{
                console.log('Loading Album '+$('#album_key').val())
                //loadAlbum($('#album_key').val());
                $(location).attr("href", $('#album_key').val());
            }
            e.preventDefault();
        });
        
        $('#find_album').on( "submit", function(e){
            if ($('#album_key_view_in').val()){
                $(location).attr("href", $('#album_key_view_in').val());
            }else{
                console.log('Loading Album '+$('#album_key_view').val())
                $(location).attr("href", $('#album_key_view').val());
            }
            e.preventDefault();
        });

        $('#hide_info_button').click( function(e){
            console.log('Hide Image Infos!');
            $('.info').hide();
            $('.image_id').hide();
            $("head").append('<style type="text/css">.info {display:none;}.image_id {display:none;}</style>');
        });

    });

    $(window).scroll(function () {
    // End of the document reached?
        if ($(document).height() - $(this).height() - 1920 < $(this).scrollTop()) {    
            console.log('Loading new images');
            if (remainingCards.length > 0){
                $('#cards').append(remainingCards.shift())
            }
            
        }
    }); 

function loadAlbum(id){
    if (id!='localAlbum'){
        if (myAlbums.has(id)){
            $.getJSON( "../album_json/"+id, function( data ) {
                console.log('The album requested is:');
                console.log(data);
                workingAlbum = data;
                workingAlbum.key = myAlbums.get(id).key
                localStorage.setItem(workingAlbum.ID, JSON.stringify(workingAlbum));
                $('#album_name').html('Viewing Album '+id);
                if ("nickname" in workingAlbum){
                    $('#nickname').html(workingAlbum.nickname);
                }
                if ("by" in workingAlbum){
                    $('#by').html(workingAlbum.by);
                }
                if ("description" in workingAlbum){
                    $('#album_description').html(workingAlbum.description);
                }
                formGallery();
                formAlbumList();
            }).fail(function(error) {
                console.log(error.responseJSON);
                alert(JSON.stringify(error.responseJSON))
            });
        }else{
            if (viewAlbums.indexOf(id) == -1){
                viewAlbums.push(id);
                localStorage.setItem("viewAlbums",JSON.stringify(viewAlbums));
            }
            $.getJSON( "../album_json/"+id, function( data ) {
                console.log('The album requested is:');
                console.log(data);
                workingAlbum = data;
                localStorage.setItem(workingAlbum.ID, JSON.stringify(workingAlbum));
                $('#album_name').html('Viewing Album '+id);
                if ("nickname" in workingAlbum){
                    $('#nickname').html(workingAlbum.nickname);
                }
                if ("by" in workingAlbum){
                    $('#by').html(workingAlbum.by);
                }
                if ("description" in workingAlbum){
                    $('#album_description').html(workingAlbum.description);
                }
                formGallery();
                formAlbumList();
            }).fail(function(error) {
                console.log(error.responseJSON);
                alert(JSON.stringify(error.responseJSON))
            });
        }

    }else{
        workingAlbum = JSON.parse(localStorage.getItem('localAlbum'))
        $('#album_name').html('Working On Album '+id);
        if ("nickname" in workingAlbum){
            $('#nickname').val(workingAlbum.nickname);
        }
        if ("by" in workingAlbum){
            $('#by').val(workingAlbum.by);
        }
        if ("description" in workingAlbum){
            $('#album_description').val(workingAlbum.description);
        }
        formGallery();
        formAlbumList();
    }


}

function formGallery(){
    var count = 0
    var cards = $("<div class='cards' id='cards'></dev>");
    remainingCards = []
    for (let idx in workingAlbum.images){
        let UUID = workingAlbum.images[workingAlbum.images.length-idx-1];
        //console.log(UUID);
        var card = $("<div  class='card' id='"+UUID+"'></div>");
        card.append($("<h3 class='image_id'>"+UUID+"</h3>"));
        card.append($("<img loading='lazy' src='../image/"+UUID+"'/>"));
        card.append($("<br class='info'/>"));
        if (!localStorage.getItem(UUID)){
            $.getJSON( "../get_info/"+UUID, function( data ) {
                localStorage.setItem(UUID, JSON.stringify(data));
            }).fail(function(error) {
                console.log(error.responseJSON);
                alert(JSON.stringify(error.responseJSON))
            });
        }
        card.append($('<pre class="info"></pre>').html(JSON.stringify(JSON.parse(localStorage.getItem(UUID)), null, 2)));
        card.append($("<br class='info'/>"));
        remainingCards.push(card);
        count++;
    }
    if (count == 0){
        $("#album_view").html('<div id = "no_result">No images in local storage.</div>');
    }else{
        for (let i = 0; i < 3; i++) {
            if (remainingCards.length > 0){
                cards.append(remainingCards.shift())
            }
        }
        $("#album_view").html('');
        $("#album_view").append(cards);
    }
    $('#album_view').show();
}
function formAlbumList(){
    console.log('refresh album options!')
    $('#album_key').html('');
    myAlbums.forEach (function(data, ID) {
        // <option value="volvo">Volvo</option>
        if (data.nickname){
            $('#album_key').append($('<option value="'+ID+'">'+ID+':'+data.nickname+'</option>'));
        }else if(JSON.parse(localStorage.getItem(ID)).nickname){
            $('#album_key').append($('<option value="'+ID+'">'+ID+':'+JSON.parse(localStorage.getItem(ID)).nickname+'</option>'));
        }else{
            $('#album_key').append($('<option value="'+ID+'">'+ID+'</option>'));
        }
    })

    $('#album_key_view').html('');
    for (i in viewAlbums){
        viewID = viewAlbums[i];
        if(JSON.parse(localStorage.getItem(viewID)).nickname){
            $('#album_key_view').append($('<option value="'+viewID+'">'+viewID+':'+JSON.parse(localStorage.getItem(viewID)).nickname+'</option>'));
        }else{
            $('#album_key_view').append($('<option value="'+viewID+'">'+viewID+'</option>'));
        }
    }
}
</script>

<footer></footer>
</body>
</html>
